=;DO FILTERING THINGSMUSIC:ґ#0НMUS3MUS0:ґCUTOFFЋ«FILTRATE»CUTOFFРMUS1ЮCUTOFF+1ТMUS2MUS1:ґCUTOFF+1НCHANSTARTґCUTOFFШ#50РCHANSTARTMUS2:ЮMUSIC+1MUS3:ґCUTOFFЧКFILTRATE»CUTOFFПMUS4ЃCUTOFF+1MUS4:ґCUTOFF+1Ш#4ПCHANSTARTґCUTOFFШ#205ПCHANSTARTЃMUSIC+1іMUS0CHANSTART:ґCUTOFF»SID+21ґCUTOFFєAєAєA»TEMPґCUTOFF+1єA≈A≈A≈AљTEMP»SID+22√NOTES_LO:°12,28,45,62,81,102,123°145,169,195,221,250,24°56,90,125,163,204,246°35,83,134,187,244,48°112,180,251,71,152,237°71,167,12,119,233,97°225,104,247,143,48,218°143,78,24,239,210,195°195,209,239,31,96,181°30,156,49,223,165,135°134,162,223,62,193,107°60,57,99,190,75,15,12°69,191,125,131,214,121°115,199,124,151,30,24°139,126,250,6,172,243°230,143,248,46NOTES_HI:°1,1,1,1,1,1,1,1,1,1,1,1°2,2,2,2,2,2,2,3,3,3,3,3°4,4,4,4,5,5,5,6,6°7,7,7,8,8,9,9,10,11,11°12,13,14,14,15,16,17,18°19,21,22,23,25,26,28,29°31,33,35,37,39,42,44,47°50,53,56,59,63,67,71,75°79,84,89,94,100,106,112°119,126,134,142,150,159°168,179,189,200,212,225°238,253BOT:;=====================================;DATA FOR MUSIC THING         EXTRASGATE_CON:®$83;               <1>SEND:®$85;               <n>END:®$FF;FOR:®$82;               <1>NEXT:®$81;               <0>KILL:®$84;               <0>STOP:®$86;               <0>PULSE:®$80;               <3>FREQS:®$87;               <0>NOFREQS:®0FILTER:®$88;               <3>CLAIM:®$89;               <0>GOSUB:®$8A;               <2>GOTO:®$8A;               <2>RETURN:®$8B;               <0>TRANSPOSE:®$8C;               <1>GATE:®$8D;               <1>;+++++++++++++++++++++++++++++++++++++TOPDATA:;.....................................TIM_A:°GATE_CON,1°SEND°5,0°6,$FF°12,0°13,$FF°19,0°20,$FF°23,%11110111°24,%00101111°END°CLAIM°FILTER,60,255Ґ50°GATE,64°PULSE,30Ґ50°TRANSPOSE,255-11°GOTOҐPLAY;.....................................TIM_B:°GATE_CON,1°TRANSPOSE,0°GATE,64°PULSE,60Ґ50°GOTOҐPLAY;.....................................TIM_C:°GATE_CON,1°TRANSPOSE,12°GATE,64°PULSE,120Ґ50°GOTOҐPLAY;.....................................PLAY:°FILTER,90,255Ґ50°40,24°FILTER,150,255Ґ50°42,8°FILTER,110,255Ґ50°40,16,38,16°FILTER,50,255Ґ50°34,48°GATE,128°SEND°5,$20°6,$F4°12,$20°13,$F4°19,$20°20,$F4°END°FILTER,110,255Ґ50°GATE_CON,15°FOR,8°40,25°NEXT°STOP;=====================================BOTDATA:;========================================€=€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее;**************************************; Z80 AY MUSIC DRIVER;**************************************ORG 40000LOAD 0C000H;======================================ASCII:EQU 23560TESTER:PUSH AFPUSH BCPUSH DEPUSH HLXOR ALD (ASCII),ALD (MINS),ALD (SECS),ACALL TUNEOFFCALL STACKMESSDB CLSDB AT,0,0DB INK,01010111BDB "'AY' MUSIC DRIVE"DB "R V1  BY S.RUDDY"DB INK,01010110B; Music nameDB "RENEGADE        "DB "                "DB INK,64+6,AT,0,3DB "DRIVER 0000:DATA"DB " 0000:TOTAL=0000"DB INK,64+2DB "EFFECT 00:TUNE 0"DB "0:TIME 00:00    "DB INK,64+8+7DB AT,0,6DB "            CH.A"DB "  CH.B  CH.C    "DB AT,0,7DB INK,64+4DB "NOTE            "DB "                "DB INK,64+4; DB   "LENGTH          "; DB   "                "DS 32,32DB INK,64+4DB "COUNT           "DB "                "DB INK,64+4DB "TRANS           "DB "                "DB INK,64+5; DB   "FOR             "; DB   "                "DS 32,32DB INK,64+5DB "NEXT            "DB "                "DB INK,64+4DB "FREQ            "DB "                "DB INK,64+4DB "DIST            "DB "                "DB INK,64+6DB "WOB-SET         "DB "                "DB INK,64+6DB "WOB-VAR         "DB "                "DB INK,64+7DB "VIB-DEL         "DB "                "DB INK,64+7DB "VIB-RAT         "DB "                "DB INK,64+7DB "VIB-LIM         "DB "                "DB INK,64+7DB "VIB-DIR         "DB "                "DB INK,64+4DB "SET-LEN         "DB "                "DB INK,64+5DB "VOLUME          "DB "                "DB 255LD HL,CALC1PUSH HLLD A,HLD DE,4067HCALL HEXPOP HLLD A,LLD DE,4069HCALL HEXLD HL,(CALC2)PUSH HLLD A,HLD DE,4071HCALL HEXPOP HLLD A,LLD DE,4073HCALL HEXLD HL,CALC1LD DE,(CALC2)ADD HL,DEPUSH HLLD A,HLD DE,407CHCALL HEXPOP HLLD A,LLD DE,407EHCALL HEXLOOP:HALT CALL UPDATELD A,2OUT (254),ACALL REFRESHXOR AOUT (254),ACALL CLOCKCALL KEYSCANLD A,07FHIN A,(254)AND 1JP NZ,LOOPLD BC,65533LD A,7OUT (C),ALD BC,49149LD A,63OUT (C),APOP HLPOP DEPOP BCPOP AFRETKEYSCAN:LD A,(ASCII)OR ARET ZKEYSCAN1:CP 32JR NC,KEYSCAN2CP 8JP Z,KEYwaitCP 9JP Z,KEYfastCP 13JR NZ,GOoutCALL TUNEOFFLD A,6OUT (254),AJR GOoutKEYSCAN2:CP 48JR C,GOoutCP 58JR NC,DOeffectAND 15LD E,ALD A,(Tunes)CP EJR Z,GOoutJR C,GOoutLD A,EPUSH AFLD DE,408FHCALL HEXPOP AFCALL TUNELD HL,0LD (MINS),HLJR GOoutDOeffect:CP 61HJR C,GOoutCP 61H+26JR NC,GOoutSUB 061HLD E,ALD A,(Effects)CP EJR Z,GOoutJR C,GOoutLD A,EPUSH AFLD DE,4087HCALL HEXPOP AFCALL FXGOout:XOR ALD (ASCII),ARETKEYwait:LD HL,ASCIILD (HL),0LD B,20KEYloop:HALT DJNZ KEYloopRETKEYfast:LD B,50KEYloop2:PUSH BCCALL REFRESHCALL CLOCKPOP BCDJNZ KEYloop2JR GOout;--------------------------------------HEX:INC DEPUSH AFCALL ONEnibPOP AFRRARRARRARRADEC DEONEnib:AND 15ADD ALD C,ALD B,0LD HL,ROM_TABADD HL,BCLD A,(HL)INC HLLD H,(HL)LD L,AMIKESbug:LD C,DLD B,8PRloop:LD A,(HL)LD (DE),AINC HLINC DDJNZ PRloopLD D,CRETROM_TAB:DW 3D80HDW 3D88HDW 3D90HDW 3D98HDW 3DA0HDW 3DA8HDW 3DB0HDW 3DB8HDW 3DC0HDW 3DC8HDW 3E08HDW 3E10HDW 3E18HDW 3E20HDW 3E28HDW 3E30HAT:EQU 22INK:EQU 16CLS:EQU 15STACKMESS:POP IXCALL MESSJP (IX)MESS:LD A,(IX+0)INC IXOR ARET MCP 32JR C,McontrolCALL MgetcharCALL MgetaddrCALL MIKESbugCALL PRattrCALL INCcursorJR MESSMcontrol:LD HL,MESSPUSH HLCP 15JR Z,MclsCP 22JP Z,MatCP 16JR Z,MinkRETMcolour:DB 0McursorX:DB 0McursorY:DB 0Mink:LD A,(IX+0)INC IXLD (Mcolour),ARETMcls:LD HL,4000HLD (HL),LLD DE,4001HLD BC,1AFFHLDIR LD (McursorX),BCRETINCcursor:LD HL,McursorXLD A,(HL)INC AAND 31LD (HL),ARET NZINC HLINC (HL)RETMgetchar:LD L,ALD H,0ADD HL,HLADD HL,HLADD HL,HLLD BC,3C00HADD HL,BCRETFIFTY:DB 50MINS:DB 0SECS:DB 0CLOCK:LD HL,FIFTYDEC (HL)RET NZLD A,50LD (HL),ALD A,(SECS)INC ALD E,AAND 15CP 10JR C,CLOCK_OKLD A,(SECS)AND 0F0HADD 16CP 60HJR NZ,COKINC HLINC (HL)LD A,(HL)AND 15CP 10JR C,NOincyLD A,(HL)AND 240ADD 16LD (HL),ANOincy:LD E,0CLOCK_OK:LD A,ECOK:LD (SECS),ALD DE,409AHCALL HEXLD A,(MINS)LD DE,4097HJP HEXUPDATE:LD A,(OLDNOTE_A)LD DE,40EEHCALL HEXLD A,(OLDNOTE_B)LD DE,40F4HCALL HEXLD A,(OLDNOTE_C)LD DE,40FAHCALL HEXLD A,(COUNT_A)LD DE,482EHCALL HEXLD A,(COUNT_B)LD DE,4834HCALL HEXLD A,(COUNT_C)LD DE,483AHCALL HEXLD A,(TRANS_A)LD DE,484EHCALL HEXLD A,(TRANS_B)LD DE,4854HCALL HEXLD A,(TRANS_C)LD DE,485AHCALL HEXLD A,(REPEAT_A)LD DE,488EHCALL HEXLD A,(REPEAT_B)LD DE,4894HCALL HEXLD A,(REPEAT_C)LD DE,489AHCALL HEXLD A,(FREQ_A+1)LD DE,48ACHCALL HEXLD A,(FREQ_B+1)LD DE,48B2HCALL HEXLD A,(FREQ_C+1)LD DE,48B8HCALL HEXLD A,(FREQ_A)LD DE,48AEHCALL HEXLD A,(FREQ_B)LD DE,48B4HCALL HEXLD A,(FREQ_C)LD DE,48BAHCALL HEXLD A,(DISTORT_A)LD DE,48CEHCALL HEXLD A,(DISTORT_B)LD DE,48D4HCALL HEXLD A,(DISTORT_C)LD DE,48DAHCALL HEXLD A,(W_DELAY_A)LD DE,48EEHCALL HEXLD A,(W_DELAY_B)LD DE,48F4HCALL HEXLD A,(W_DELAY_C)LD DE,48FAHCALL HEXLD A,(W_OFF_A)LD DE,500EHCALL HEXLD A,(W_OFF_B)LD DE,5014HCALL HEXLD A,(W_OFF_C)LD DE,501AHCALL HEXLD A,(V_DEL_A)LD DE,502EHCALL HEXLD A,(V_DEL_B)LD DE,5034HCALL HEXLD A,(V_DEL_C)LD DE,503AHCALL HEXLD A,(V_RATE_A)LD DE,504EHCALL HEXLD A,(V_RATE_B)LD DE,5054HCALL HEXLD A,(V_RATE_C)LD DE,505AHCALL HEXLD A,(V_LIM2_A)LD DE,506EHCALL HEXLD A,(V_LIM2_B)LD DE,5074HCALL HEXLD A,(V_LIM2_C)LD DE,507AHCALL HEXLD A,(V_DIR_A)LD DE,508EHCALL HEXLD A,(V_DIR_B)LD DE,5094HCALL HEXLD A,(V_DIR_C)LD DE,509AHCALL HEXLD A,(LENGTH_A)LD DE,50AEHCALL HEXLD A,(LENGTH_B)LD DE,50B4HCALL HEXLD A,(LENGTH_C)LD DE,50BAHCALL HEXLD A,(VOLUME_A)LD DE,50CEHCALL HEXLD A,(VOLUME_B)LD DE,50D4HCALL HEXLD A,(VOLUME_C)LD DE,50DAHCALL HEXRETMgetaddr:LD A,(McursorY)AND 18HOR 40HLD D,ALD A,(McursorY)RRCA RRCA RRCA AND 0E0HLD E,ALD A,(McursorX)ADD ELD E,ARETMat:LD A,(IX+0)LD (McursorX),AINC IXLD A,(IX+0)LD (McursorY),AINC IXRETPRattr:LD A,DRRARRARRAAND 3OR 58HLD D,ALD A,(Mcolour)LD (DE),ARET;======================================; AY MUSIC DRIVER V1.00 BY S.RUDDYCODE_TOP:PC_A:DW 0PC_B:DW 0PC_C:DW 0RETURN_A:DW 0RETURN_B:DW 0RETURN_C:DW 0STACK_A:DW 0STACK_B:DW 0STACK_C:DW 0FREQ_A:DW 0FREQ_B:DW 0FREQ_C:DW 0STOP_A:DB 0STOP_B:DB 0STOP_C:DB 0TRANS_A:DB 0TRANS_B:DB 0TRANS_C:DB 0LENGTH_A:DB 0LENGTH_B:DB 0LENGTH_C:DB 0IGNORE_A:DB 0IGNORE_B:DB 0IGNORE_C:DB 0W_WAIT_A:DB 0W_WAIT_B:DB 0W_WAIT_C:DB 0W_DELAY_A:DB 0W_DELAY_B:DB 0W_DELAY_C:DB 0PORT_A:DB 0PORT_B:DB 0PORT_C:DB 0V_DEL_A:DB 0V_DEL_B:DB 0V_DEL_C:DB 0E_TIME_A:DB 0E_TIME_B:DB 0E_TIME_C:DB 0REPEAT_A:DB 0REPEAT_B:DB 0REPEAT_C:DB 0DISTORT_A:DB 0DISTORT_B:DB 0DISTORT_C:DB 0COUNT_A:DB 0COUNT_B:DB 0COUNT_C:DB 0OLDFREQ_A:DB 0OLDFREQ_B:DB 0OLDFREQ_C:DB 0A_CONT_A:DB 0A_CONT_B:DB 0A_CONT_C:DB 0VOLUME_A:DB 0VOLUME_B:DB 0VOLUME_C:DB 0FLIP1_A:DB 0FLIP1_B:DB 0FLIP1_C:DB 0OLDNOTE_A:DB 0OLDNOTE_B:DB 0OLDNOTE_C:DB 0A_INIT_A:DB 0A_INIT_B:DB 0A_INIT_C:DB 0A_ATT_A:DB 0A_DEC_A:DB 0A_ATT_B:DB 0A_DEC_B:DB 0A_ATT_C:DB 0A_DEC_C:DB 0A_SUS_A:DB 0A_SUS_B:DB 0A_SUS_C:DB 0A_CYC_A:DB 0A_CYC_B:DB 0A_CYC_C:DB 0A_STAGE_A:DB 0A_STAGE_B:DB 0A_STAGE_C:DB 0A_TIME_A:DB 0A_TIME_B:DB 0A_TIME_C:DB 0W_OFF_A:DB 0W_OFF_B:DB 0W_OFF_C:DB 0TARGET_A:DB 0TARGET_B:DB 0TARGET_C:DB 0V_DEL1_A:DB 0V_DEL1_B:DB 0V_DEL1_C:DB 0V_RATE_A:DB 0V_RATE_B:DB 0V_RATE_C:DB 0V_LIM1_A:DB 0V_LIM1_B:DB 0V_LIM1_C:DB 0V_LIM2_A:DB 0V_LIM2_B:DB 0V_LIM2_C:DB 0V_DIR_A:DB 0V_DIR_B:DB 0V_DIR_C:DB 0E_FREQ_A:DW 0E_FREQ_B:DW 0E_FREQ_C:DW 0E_WAIT_A:DB 0E_WAIT_B:DB 0E_WAIT_C:DB 0E_BITS_A:DB 0E_BITS_B:DB 0E_BITS_C:DB 0REGISTER:DB 0REGISTER2:DB 0;--------------------------------------; tune initialisation enter with; a = tune number.TUNE:ADD ALD C,ALD B,0LD HL,TUNES_AADD HL,BCLD E,(HL)INC HLLD D,(HL)LD (PC_A),DELD HL,TUNES_BADD HL,BCLD E,(HL)INC HLLD D,(HL)LD (PC_B),DELD HL,TUNES_CADD HL,BCLD E,(HL)INC HLLD D,(HL)LD (PC_C),DELD A,0FFHLD (STOP_A),ALD (STOP_B),ALD (STOP_C),ATUNE_IN:LD (OLDFREQ_A),ALD (OLDFREQ_B),ALD (OLDFREQ_C),ALD HL,TRANS_ALD DE,TRANS_A+1LD BC,23LD (HL),0LDIR LD A,1LD (COUNT_A),ALD (COUNT_B),ALD (COUNT_C),ARET;--------------------------------------; call before initialising sound fxTUNEOFF:LD C,0LD A,8CALL OUT_CA_AYLD C,0LD A,9CALL OUT_CA_AYLD C,0LD A,10CALL OUT_CA_AYXOR ALD (STOP_A),ALD (STOP_B),ALD (STOP_C),ADEC AJP TUNE_IN;--------------------------------------; do fx. enter with a = fx numberFX:ADD ALD HL,FX_TABCALL ADDHLALD A,(HL)INC HLLD H,(HL)LD L,AFLOOP:EX DE,HLLD A,(DE)OR ARET M; RRASRL ALD HL,STOP_ACALL ADDHLALD (HL),255LD HL,COUNT_ALD A,(DE)SRL ACALL ADDHLALD (HL),1LD A,(DE)LD HL,PC_ACALL ADDHLAINC DEEX DE,HLLDILDIJR FLOOPADDHLA:ADD LLD L,ARET NCINC HRET;--------------------------------------; main routine, call once per frameREFRESH:CHANNEL_A:LD A,(STOP_A)OR AJP P,CHANNEL_BSTART_A:LD A,(A_STAGE_A)OR AJP NZ,TESTDEC_ALD HL,A_TIME_ADEC (HL)JP P,ENDADSR_ALD A,(A_ATT_A)LD (HL),ALD HL,VOLUME_AINC (HL)LD A,(HL)CP 15JP NZ,ENDADSR_ALD A,1LD (A_STAGE_A),ALD A,(A_DEC_A)LD (A_TIME_A),AJP ENDADSR_ATESTDEC_A:CP 1JP NZ,ENDADSR_ALD HL,A_TIME_ADEC (HL)JP P,ENDADSR_ALD A,(A_DEC_A)LD (HL),ALD A,(VOLUME_A)LD HL,A_SUS_ACP (HL)JP Z,SET_SUS_ADEC ALD (VOLUME_A),AJP P,ENDADSR_ASET_SUS_A:LD A,2LD (A_STAGE_A),AENDADSR_A:LD A,(VOLUME_A)LD C,ALD A,8CALL OUT_CA_AYTESTEFF_A:LD A,(E_TIME_A)OR AJP Z,TESTVIB_ALD A,(E_WAIT_A)OR AJP Z,TESTVIB_ADEC ALD (E_WAIT_A),AJP NZ,TSTCNT_ALD A,(FREQ_A)LD C,AXOR ACALL OUT_CA_AYLD A,(FREQ_A+1)LD C,ALD A,1CALL OUT_CA_AYLD A,(REGISTER)AND 00001001BLD E,ALD A,(REGISTER2)AND 00110110BOR ELD (REGISTER2),ALD C,ALD A,7CALL OUT_CA_AYTESTVIB_A:LD A,(V_DEL_A)OR AJP Z,TSTWOB_ALD A,(V_DEL1_A)OR AJP Z,VSTART_ADEC ALD (V_DEL1_A),AJP NZ,